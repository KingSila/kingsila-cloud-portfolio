name: Terraform CI/CD

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-ci.yml'
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run (dev/test/prod)'
        required: true
        type: choice
        options: [ dev, test, prod ]

permissions:
  id-token: write        # required for OIDC
  contents: read

env:
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

  ARM_USE_OIDC: true
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  terraform:
    name: Terraform ${{ inputs.environment || 'dev' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: infra

    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false

      - name: Terraform Init (remote backend per env)
        run: |
          terraform init \
            -upgrade \
            -lock-timeout=2m \
            -input=false \
            -backend-config="resource_group_name=tfstate-rg" \
            -backend-config="storage_account_name=tfstatekingsila" \
            -backend-config="container_name=state" \
            -backend-config="key=${ENVIRONMENT}/terraform.tfstate"

      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file="env/${ENVIRONMENT}.tfvars" \
            -out="tfplan-${ENVIRONMENT}"

      # Optional: upload plan as artifact on PRs
      - name: Upload Plan Artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ env.ENVIRONMENT }}
          path: infra/tfplan-${{ env.ENVIRONMENT }}

      # Only apply on push to main or manual dispatch
      - name: Terraform Apply
        if: github.event_name != 'pull_request'
        run: |
          terraform apply -auto-approve "tfplan-${ENVIRONMENT}"

      # Set Key Vault secret after apply (per environment)
      - name: Set Key Vault connection-string secret
        if: github.event_name != 'pull_request'
        run: |
          case "${ENVIRONMENT}" in
            dev)
              KV_NAME="kv-mainkingsila-dev"
              DB_SECRET="${{ secrets.DB_CONNECTION_STRING_DEV }}"
              ;;
            test)
              KV_NAME="kv-mainkingsila-test"
              DB_SECRET="${{ secrets.DB_CONNECTION_STRING_TEST }}"
              ;;
            prod)
              KV_NAME="kv-mainkingsila-prod"
              DB_SECRET="${{ secrets.DB_CONNECTION_STRING_PROD }}"
              ;;
            *)
              echo "Unknown environment: ${ENVIRONMENT}"
              exit 1
              ;;
          esac

          if [ -z "$DB_SECRET" ]; then
            echo "Database connection string secret is not set for ${ENVIRONMENT}"
            exit 1
          fi

          echo "Setting Key Vault secret 'connection-string' in $KV_NAME for ${ENVIRONMENT}..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "connection-string" \
            --value "$DB_SECRET"

      # Optional: output URLs/info to logs
      - name: Show useful outputs
        if: github.event_name != 'pull_request'
        run: |
          echo "Fetching Terraform outputs..."
          terraform output -json
