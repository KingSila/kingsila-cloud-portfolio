name: Terraform CI/CD

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-ci.yml'

  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-ci.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run (dev/test/prod)'
        required: true
        type: choice
        options: [ dev, test, prod ]

env:
  TERRAFORM_VERSION: '1.9.8'
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  ARM_USE_OIDC: true
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  enable-AzPSSession: false

permissions:
  contents: read
  id-token: write

jobs:
  # ─────────────────────────────────────────────
  # PR: Plan only for all environments
  # ─────────────────────────────────────────────
  plan-on-pr:
    name: Terraform Plan (PR) – ${{ matrix.environment }}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}

    strategy:
      fail-fast: false
      matrix:
        environment: [ dev, test, prod ]

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform init \
            -input=false

      - name: Terraform Validate (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: terraform validate

      - name: Terraform Plan (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform plan \
            -no-color \
            -var-file=${{ env.ENVIRONMENT }}.tfvars

  # ─────────────────────────────────────────────
  # Push to main: Plan + Apply for all envs
  # ─────────────────────────────────────────────
  plan-apply-on-main:
    name: Terraform Plan & Apply (main) – ${{ matrix.environment }}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    strategy:
      fail-fast: false
      matrix:
        environment: [ dev, test, prod ]

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform init \
            -input=false

      - name: Terraform Validate (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: terraform validate

      - name: Terraform Plan (${{ env.ENVIRONMENT }})
        id: plan
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform plan \
            -no-color \
            -out=tfplan.${{ env.ENVIRONMENT }} \
            -var-file=${{ env.ENVIRONMENT }}.tfvars

      - name: Terraform Apply (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform apply \
            -input=false \
            tfplan.${{ env.ENVIRONMENT }}

      - name: Set Key Vault secrets for ${{ env.ENVIRONMENT }}
        if: success()
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        shell: bash
        run: |
          echo "Environment: ${ENVIRONMENT}"

          # Map env -> GitHub secret
          if [ "${ENVIRONMENT}" = "dev" ]; then
            CONN_STR="${{ secrets.DB_CONNECTION_STRING_DEV }}"
          elif [ "${ENVIRONMENT}" = "test" ]; then
            CONN_STR="${{ secrets.DB_CONNECTION_STRING_TEST }}"
          elif [ "${ENVIRONMENT}" = "prod" ]; then
            CONN_STR="${{ secrets.DB_CONNECTION_STRING_PROD }}"
          else
            echo "Unknown environment: ${ENVIRONMENT}"
            exit 1
          fi

          if [ -z "$CONN_STR" ]; then
            echo "Connection string secret for ${ENVIRONMENT} is not set in GitHub Secrets."
            exit 1
          fi

          # Get Key Vault name from Terraform output
          KV_NAME=$(terraform output -raw keyvault_name)

          echo "Setting 'connection-string' secret in Key Vault: $KV_NAME"

          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "connection-string" \
            --value "$CONN_STR"


  # ─────────────────────────────────────────────
  # Manual run: Plan + Apply for a single env
  # ─────────────────────────────────────────────
  plan-apply-manual:
    name: Terraform Plan & Apply (manual) – ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform init \
            -input=false

      - name: Terraform Validate (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: terraform validate

      - name: Terraform Plan (${{ env.ENVIRONMENT }})
        id: plan
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform plan \
            -no-color \
            -out=tfplan.${{ env.ENVIRONMENT }} \
            -var-file=${{ env.ENVIRONMENT }}.tfvars

      - name: Terraform Apply (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform apply \
            -input=false \
            tfplan.${{ env.ENVIRONMENT }}

      - name: Set Key Vault secrets for ${{ env.ENVIRONMENT }}
        if: success()
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        shell: bash
        run: |
          echo "Environment: ${ENVIRONMENT}"

          # Map env -> GitHub secret
          if [ "${ENVIRONMENT}" = "dev" ]; then
            CONN_STR="${{ secrets.DB_CONNECTION_STRING_DEV }}"
          elif [ "${ENVIRONMENT}" = "test" ]; then
            CONN_STR="${{ secrets.DB_CONNECTION_STRING_TEST }}"
          elif [ "${ENVIRONMENT}" = "prod" ]; then
            CONN_STR="${{ secrets.DB_CONNECTION_STRING_PROD }}"
          else
            echo "Unknown environment: ${ENVIRONMENT}"
            exit 1
          fi

          if [ -z "$CONN_STR" ]; then
            echo "Connection string secret for ${ENVIRONMENT} is not set in GitHub Secrets."
            exit 1
          fi

          # Get Key Vault name from Terraform output
          KV_NAME=$(terraform output -raw keyvault_name)

          echo "Setting 'connection-string' secret in Key Vault: $KV_NAME"

          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "connection-string" \
            --value "$CONN_STR"
