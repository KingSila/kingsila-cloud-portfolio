name: Terraform CI/CD - Infastrcuture

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-ci.yml'

  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-ci.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run (dev/test/prod)'
        required: true
        type: choice
        options: [ dev, test, prod ]

env:
  TERRAFORM_VERSION: '1.9.8'
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  ARM_USE_OIDC: true
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  enable-AzPSSession: false

permissions:
  contents: read
  id-token: write

jobs:
  # ─────────────────────────────────────────────
  # PR: Plan only for all environments (matrix)
  # ─────────────────────────────────────────────
  plan-on-pr:
    name: Terraform Plan (PR) – ${{ matrix.environment }}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}

    strategy:
      fail-fast: false
      matrix:
        environment: [ dev, test, prod ]

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform init -input=false

      - name: Terraform Validate (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: terraform validate

      - name: Terraform Plan (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform plan \
            -no-color \
            -var-file=${{ env.ENVIRONMENT }}.tfvars

  # ─────────────────────────────────────────────
  # Push to main: Promotion dev → test → prod
  # ─────────────────────────────────────────────

  deploy-dev:
    name: Terraform Plan & Apply – dev
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    environment: dev

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (dev)
        working-directory: infra/envs/dev
        run: |
          terraform init -input=false

      - name: Terraform Validate (dev)
        working-directory: infra/envs/dev
        run: terraform validate

      - name: Terraform Plan (dev)
        id: plan-dev
        working-directory: infra/envs/dev
        run: |
          terraform plan \
            -no-color \
            -out=tfplan.dev \
            -var-file=dev.tfvars

      - name: Terraform Apply (dev)
        working-directory: infra/envs/dev
        run: |
          terraform apply \
            -input=false \
            tfplan.dev

  deploy-test:
    name: Terraform Plan & Apply – test
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    environment: test

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (test)
        working-directory: infra/envs/test
        run: |
          terraform init -input=false

      - name: Terraform Validate (test)
        working-directory: infra/envs/test
        run: terraform validate

      - name: Terraform Plan (test)
        id: plan-test
        working-directory: infra/envs/test
        run: |
          terraform plan \
            -no-color \
            -out=tfplan.test \
            -var-file=test.tfvars

      - name: Terraform Apply (test)
        working-directory: infra/envs/test
        run: |
          terraform apply \
            -input=false \
            tfplan.test

  deploy-prod:
    name: Terraform Plan & Apply – prod
    runs-on: ubuntu-latest
    needs: deploy-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    environment: prod

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (prod)
        working-directory: infra/envs/prod
        run: |
          terraform init -input=false

      - name: Terraform Validate (prod)
        working-directory: infra/envs/prod
        run: terraform validate

      - name: Terraform Plan (prod)
        id: plan-prod
        working-directory: infra/envs/prod
        run: |
          terraform plan \
            -no-color \
            -out=tfplan.prod \
            -var-file=prod.tfvars

      - name: Terraform Apply (prod)
        working-directory: infra/envs/prod
        run: |
          terraform apply \
            -input=false \
            tfplan.prod

  # ─────────────────────────────────────────────
  # Manual run: Plan + Apply for a single env
  # ─────────────────────────────────────────────
  plan-apply-manual:
    name: Terraform Plan & Apply (manual) – ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}

    defaults:
      run:
        shell: bash

    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Terraform Init (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform init -input=false

      - name: Terraform Validate (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: terraform validate

      - name: Terraform Plan (${{ env.ENVIRONMENT }})
        id: plan-manual
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform plan \
            -no-color \
            -out=tfplan.${{ env.ENVIRONMENT }} \
            -var-file=${{ env.ENVIRONMENT }}.tfvars

      - name: Terraform Apply (${{ env.ENVIRONMENT }})
        working-directory: infra/envs/${{ env.ENVIRONMENT }}
        run: |
          terraform apply \
            -input=false \
            tfplan.${{ env.ENVIRONMENT }}
