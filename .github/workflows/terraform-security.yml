name: Terraform Security Scan

on:
  pull_request:
    paths:
      - "infra/**"
      - ".github/workflows/**"

permissions:
  contents: read
  security-events: write  # needed for SARIF upload

jobs:
  tfsec-and-checkov:
    name: Terraform security scans (tfsec + checkov)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      ###############################################################
      # 1) tfsec SARIF via official tfsec-sarif-action
      #    - This runs tfsec and writes tfsec.sarif for upload
      ###############################################################
      - name: Run tfsec (SARIF)
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          sarif_file: tfsec.sarif
          working_directory: infra
          # optional extras if you want:
          # tfsec_version: latest
          # tfsec_args: '--exclude-path infra/legacy'

      - name: Upload tfsec SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec.sarif

      ###############################################################
      # 2) Checkov SARIF via CLI + upload
      ###############################################################
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: |
          python -m pip install --upgrade pip
          pip install checkov

      # Non-blocking for now: we want visibility first, then enforcement later
      - name: Run Checkov (SARIF, non-blocking)
        run: |
          checkov \
            -d infra \
            -o sarif \
            --output-file-path checkov.sarif || true

      - name: Upload Checkov SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif

      ###############################################################
      # 3) (Optional) Strict gates when you're ready to enforce
      ###############################################################
      # - name: Enforce tfsec (fail on HIGH+)
      #   run: |
      #     tfsec infra --minimum-severity HIGH
      #
      # - name: Enforce Checkov (fail on HIGH+)
      #   run: |
      #     checkov -d infra --soft-fail-on MEDIUM
